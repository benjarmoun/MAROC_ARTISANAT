import{Fragment as Q,computed as D,defineComponent as L,h as H,inject as A,provide as V,ref as I,watchEffect as _}from"vue";import{match as R}from"../../utils/match.js";import{render as x,Features as j}from"../../utils/render.js";import{useId as F}from"../../hooks/use-id.js";import{Keys as T}from"../../keyboard.js";import{getFocusableElements as ne,Focus as C,focusIn as w,isFocusableElement as re,FocusableMode as le}from"../../utils/focus-management.js";import{dom as r}from"../../utils/dom.js";import{useOpenClosedProvider as ae,State as G,useOpenClosed as X}from"../../internal/open-closed.js";import{useResolveButtonType as ue}from"../../hooks/use-resolve-button-type.js";import{useOutsideClick as ie}from"../../hooks/use-outside-click.js";import{getOwnerDocument as N}from"../../utils/owner.js";import{useEventListener as se}from"../../hooks/use-event-listener.js";import{Hidden as q,Features as U}from"../../internal/hidden.js";import{useTabDirection as Y,Direction as M}from"../../hooks/use-tab-direction.js";import"../../utils/micro-task.js";var pe=(c=>(c[c.Open=0]="Open",c[c.Closed=1]="Closed",c))(pe||{});let Z=Symbol("PopoverContext");function W(P){let S=A(Z,null);if(S===null){let c=new Error(`<${P} /> is missing a parent <${ve.name} /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(c,W),c}return S}let ee=Symbol("PopoverGroupContext");function te(){return A(ee,null)}let oe=Symbol("PopoverPanelContext");function fe(){return A(oe,null)}let ve=L({name:"Popover",props:{as:{type:[Object,String],default:"div"}},setup(P,{slots:S,attrs:c,expose:E}){var v;let t=`headlessui-popover-button-${F()}`,e=`headlessui-popover-panel-${F()}`,m=I(null);E({el:m,$el:m});let a=I(1),b=I(null),g=I(null),y=I(null),s=I(null),f=D(()=>N(m)),O=D(()=>{if(!r(b)||!r(s))return!1;for(let n of document.querySelectorAll("body > *"))if(Number(n==null?void 0:n.contains(r(b)))^Number(n==null?void 0:n.contains(r(s))))return!0;return!1}),d={popoverState:a,buttonId:t,panelId:e,panel:s,button:b,isPortalled:O,beforePanelSentinel:g,afterPanelSentinel:y,togglePopover(){a.value=R(a.value,{[0]:1,[1]:0})},closePopover(){a.value!==1&&(a.value=1)},close(n){d.closePopover();let i=(()=>n?n instanceof HTMLElement?n:n.value instanceof HTMLElement?r(n):r(d.button):r(d.button))();i==null||i.focus()}};V(Z,d),ae(D(()=>R(a.value,{[0]:G.Open,[1]:G.Closed})));let h={buttonId:t,panelId:e,close(){d.closePopover()}},l=te(),o=l==null?void 0:l.registerPopover;function u(){var n,i,p,k;return(k=l==null?void 0:l.isFocusWithinPopoverGroup())!=null?k:((n=f.value)==null?void 0:n.activeElement)&&(((i=r(b))==null?void 0:i.contains(f.value.activeElement))||((p=r(s))==null?void 0:p.contains(f.value.activeElement)))}return _(()=>o==null?void 0:o(h)),se((v=f.value)==null?void 0:v.defaultView,"focus",n=>{var i,p;a.value===0&&(u()||!b||!s||(i=r(d.beforePanelSentinel))!=null&&i.contains(n.target)||(p=r(d.afterPanelSentinel))!=null&&p.contains(n.target)||d.closePopover())},!0),ie([b,s],(n,i)=>{var p;a.value===0&&(d.closePopover(),re(i,le.Loose)||(n.preventDefault(),(p=r(b))==null||p.focus()))}),()=>{let n={open:a.value===0,close:d.close};return x({props:{...P,ref:m},slot:n,slots:S,attrs:c,name:"Popover"})}}}),ke=L({name:"PopoverButton",props:{as:{type:[Object,String],default:"button"},disabled:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(P,{attrs:S,slots:c,expose:E}){let t=W("PopoverButton"),e=D(()=>N(t.button));E({el:t.button,$el:t.button});let m=te(),a=m==null?void 0:m.closeOthers,b=fe(),g=b===null?!1:b===t.panelId,y=I(null),s=`headlessui-focus-sentinel-${F()}`;g||_(()=>{t.button.value=y.value});let f=ue(D(()=>({as:P.as,type:S.type})),y);function O(o){var u,v,n,i,p;if(g){if(t.popoverState.value===1)return;switch(o.key){case T.Space:case T.Enter:o.preventDefault(),(v=(u=o.target).click)==null||v.call(u),t.closePopover(),(n=r(t.button))==null||n.focus();break}}else switch(o.key){case T.Space:case T.Enter:o.preventDefault(),o.stopPropagation(),t.popoverState.value===1&&(a==null||a(t.buttonId)),t.togglePopover();break;case T.Escape:if(t.popoverState.value!==0)return a==null?void 0:a(t.buttonId);if(!r(t.button)||((i=e.value)==null?void 0:i.activeElement)&&!((p=r(t.button))!=null&&p.contains(e.value.activeElement)))return;o.preventDefault(),o.stopPropagation(),t.closePopover();break}}function d(o){g||o.key===T.Space&&o.preventDefault()}function h(o){var u,v;P.disabled||(g?(t.closePopover(),(u=r(t.button))==null||u.focus()):(o.preventDefault(),o.stopPropagation(),t.popoverState.value===1&&(a==null||a(t.buttonId)),t.togglePopover(),(v=r(t.button))==null||v.focus()))}function l(o){o.preventDefault(),o.stopPropagation()}return()=>{let o=t.popoverState.value===0,u={open:o},v=g?{ref:y,type:f.value,onKeydown:O,onClick:h}:{ref:y,id:t.buttonId,type:f.value,"aria-expanded":P.disabled?void 0:t.popoverState.value===0,"aria-controls":r(t.panel)?t.panelId:void 0,disabled:P.disabled?!0:void 0,onKeydown:O,onKeyup:d,onClick:h,onMousedown:l},n=Y();function i(){let p=r(t.panel);if(!p)return;function k(){R(n.value,{[M.Forwards]:()=>w(p,C.First),[M.Backwards]:()=>w(p,C.Last)})}k()}return H(Q,[x({props:{...S,...P,...v},slot:u,attrs:S,slots:c,name:"PopoverButton"}),o&&!g&&t.isPortalled.value&&H(q,{id:s,features:U.Focusable,as:"button",type:"button",onFocus:i})])}}}),Be=L({name:"PopoverOverlay",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0}},setup(P,{attrs:S,slots:c}){let E=W("PopoverOverlay"),t=`headlessui-popover-overlay-${F()}`,e=X(),m=D(()=>e!==null?e.value===G.Open:E.popoverState.value===0);function a(){E.closePopover()}return()=>{let b={open:E.popoverState.value===0};return x({props:{...P,...{id:t,"aria-hidden":!0,onClick:a}},slot:b,attrs:S,slots:c,features:j.RenderStrategy|j.Static,visible:m.value,name:"PopoverOverlay"})}}}),Le=L({name:"PopoverPanel",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},focus:{type:Boolean,default:!1}},inheritAttrs:!1,setup(P,{attrs:S,slots:c,expose:E}){let{focus:t}=P,e=W("PopoverPanel"),m=D(()=>N(e.panel)),a=`headlessui-focus-sentinel-before-${F()}`,b=`headlessui-focus-sentinel-after-${F()}`;E({el:e.panel,$el:e.panel}),V(oe,e.panelId),_(()=>{var o,u;if(!t||e.popoverState.value!==0||!e.panel)return;let l=(o=m.value)==null?void 0:o.activeElement;(u=r(e.panel))!=null&&u.contains(l)||w(r(e.panel),C.First)});let g=X(),y=D(()=>g!==null?g.value===G.Open:e.popoverState.value===0);function s(l){var o,u;switch(l.key){case T.Escape:if(e.popoverState.value!==0||!r(e.panel)||m.value&&!((o=r(e.panel))!=null&&o.contains(m.value.activeElement)))return;l.preventDefault(),l.stopPropagation(),e.closePopover(),(u=r(e.button))==null||u.focus();break}}function f(l){var u,v,n,i,p;let o=l.relatedTarget;!o||!r(e.panel)||(u=r(e.panel))!=null&&u.contains(o)||(e.closePopover(),(((n=(v=r(e.beforePanelSentinel))==null?void 0:v.contains)==null?void 0:n.call(v,o))||((p=(i=r(e.afterPanelSentinel))==null?void 0:i.contains)==null?void 0:p.call(i,o)))&&o.focus({preventScroll:!0}))}let O=Y();function d(){let l=r(e.panel);if(!l)return;function o(){R(O.value,{[M.Forwards]:()=>{w(l,C.First)},[M.Backwards]:()=>{var u;(u=r(e.button))==null||u.focus({preventScroll:!0})}})}o()}function h(){let l=r(e.panel);if(!l)return;function o(){R(O.value,{[M.Forwards]:()=>{var $,z;let u=r(e.button),v=r(e.panel);if(!u)return;let n=ne(),i=n.indexOf(u),p=n.slice(0,i+1),K=[...n.slice(i+1),...p];for(let B of K.slice())if(((z=($=B==null?void 0:B.id)==null?void 0:$.startsWith)==null?void 0:z.call($,"headlessui-focus-sentinel-"))||(v==null?void 0:v.contains(B))){let J=K.indexOf(B);J!==-1&&K.splice(J,1)}w(K,C.First,!1)},[M.Backwards]:()=>w(l,C.Last)})}o()}return()=>{let l={open:e.popoverState.value===0,close:e.close},o={ref:e.panel,id:e.panelId,onKeydown:s,onFocusout:t&&e.popoverState.value===0?f:void 0,tabIndex:-1};return H(Q,[y.value&&e.isPortalled.value&&H(q,{id:a,ref:e.beforePanelSentinel,features:U.Focusable,as:"button",type:"button",onFocus:d}),x({props:{...S,...P,...o},slot:l,attrs:S,slots:c,features:j.RenderStrategy|j.Static,visible:y.value,name:"PopoverPanel"}),y.value&&e.isPortalled.value&&H(q,{id:b,ref:e.afterPanelSentinel,features:U.Focusable,as:"button",type:"button",onFocus:h})])}}}),He=L({name:"PopoverGroup",props:{as:{type:[Object,String],default:"div"}},setup(P,{attrs:S,slots:c,expose:E}){let t=I(null),e=I([]),m=D(()=>N(t));E({el:t,$el:t});function a(s){let f=e.value.indexOf(s);f!==-1&&e.value.splice(f,1)}function b(s){return e.value.push(s),()=>{a(s)}}function g(){var O;let s=m.value;if(!s)return!1;let f=s.activeElement;return(O=r(t))!=null&&O.contains(f)?!0:e.value.some(d=>{var h,l;return((h=s.getElementById(d.buttonId))==null?void 0:h.contains(f))||((l=s.getElementById(d.panelId))==null?void 0:l.contains(f))})}function y(s){for(let f of e.value)f.buttonId!==s&&f.close()}return V(ee,{registerPopover:b,unregisterPopover:a,isFocusWithinPopoverGroup:g,closeOthers:y}),()=>x({props:{...P,...{ref:t}},slot:{},attrs:S,slots:c,name:"PopoverGroup"})}});export{ve as Popover,ke as PopoverButton,He as PopoverGroup,Be as PopoverOverlay,Le as PopoverPanel};
