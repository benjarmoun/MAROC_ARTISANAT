import{Fragment as N,computed as L,defineComponent as M,h as j,inject as U,nextTick as k,onMounted as E,onUnmounted as z,provide as $,ref as D,toRaw as R,watch as Q,watchEffect as q}from"vue";import{Features as B,render as I,omit as K,compact as W}from"../../utils/render.js";import{useId as A}from"../../hooks/use-id.js";import{Keys as c}from"../../keyboard.js";import{calculateActiveIndex as _,Focus as b}from"../../utils/calculate-active-index.js";import{dom as v}from"../../utils/dom.js";import{useOpenClosed as G,State as F,useOpenClosedProvider as J}from"../../internal/open-closed.js";import{match as C}from"../../utils/match.js";import{useResolveButtonType as X}from"../../hooks/use-resolve-button-type.js";import{FocusableMode as Y,isFocusableElement as Z,sortByDomNode as ee}from"../../utils/focus-management.js";import{useOutsideClick as te}from"../../hooks/use-outside-click.js";import{Hidden as oe,Features as ie}from"../../internal/hidden.js";import{objectToFormEntries as ae}from"../../utils/form.js";var le=(n=>(n[n.Open=0]="Open",n[n.Closed=1]="Closed",n))(le||{}),ne=(n=>(n[n.Single=0]="Single",n[n.Multi=1]="Multi",n))(ne||{}),ue=(n=>(n[n.Pointer=0]="Pointer",n[n.Other=1]="Other",n))(ue||{});function re(i){requestAnimationFrame(()=>requestAnimationFrame(i))}let H=Symbol("ListboxContext");function P(i){let x=U(H,null);if(x===null){let n=new Error(`<${i} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(n,P),n}return x}let we=M({name:"Listbox",emits:{"update:modelValue":i=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},horizontal:{type:[Boolean],default:!1},modelValue:{type:[Object,String,Number,Boolean]},name:{type:String,optional:!0},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(i,{slots:x,attrs:n,emit:S}){let e=D(1),p=D(null),d=D(null),m=D(null),s=D([]),O=D(""),t=D(null),l=D(1);function w(o=a=>a){let a=t.value!==null?s.value[t.value]:null,u=ee(o(s.value.slice()),g=>v(g.dataRef.domRef)),f=a?u.indexOf(a):null;return f===-1&&(f=null),{options:u,activeOptionIndex:f}}let y=L(()=>i.modelValue),T=L(()=>i.multiple?1:0),r={listboxState:e,value:y,mode:T,compare(o,a){return o===a},orientation:L(()=>i.horizontal?"horizontal":"vertical"),labelRef:p,buttonRef:d,optionsRef:m,disabled:L(()=>i.disabled),options:s,searchQuery:O,activeOptionIndex:t,activationTrigger:l,closeListbox(){i.disabled||e.value!==1&&(e.value=1,t.value=null)},openListbox(){i.disabled||e.value!==0&&(e.value=0)},goToOption(o,a,u){if(i.disabled||e.value===1)return;let f=w(),g=_(o===b.Specific?{focus:b.Specific,id:a}:{focus:o},{resolveItems:()=>f.options,resolveActiveIndex:()=>f.activeOptionIndex,resolveId:h=>h.id,resolveDisabled:h=>h.dataRef.disabled});O.value="",t.value=g,l.value=u!=null?u:1,s.value=f.options},search(o){if(i.disabled||e.value===1)return;let u=O.value!==""?0:1;O.value+=o.toLowerCase();let g=(t.value!==null?s.value.slice(t.value+u).concat(s.value.slice(0,t.value+u)):s.value).find(V=>V.dataRef.textValue.startsWith(O.value)&&!V.dataRef.disabled),h=g?s.value.indexOf(g):-1;h===-1||h===t.value||(t.value=h,l.value=1)},clearSearch(){i.disabled||e.value!==1&&O.value!==""&&(O.value="")},registerOption(o,a){let u=w(f=>[...f,{id:o,dataRef:a}]);s.value=u.options,t.value=u.activeOptionIndex},unregisterOption(o){let a=w(u=>{let f=u.findIndex(g=>g.id===o);return f!==-1&&u.splice(f,1),u});s.value=a.options,t.value=a.activeOptionIndex,l.value=1},select(o){i.disabled||S("update:modelValue",C(T.value,{[0]:()=>o,[1]:()=>{let a=R(r.value.value).slice(),u=R(o),f=a.findIndex(g=>r.compare(u,R(g)));return f===-1?a.push(u):a.splice(f,1),a}}))}};return te([d,m],(o,a)=>{var u;e.value===0&&(r.closeListbox(),Z(a,Y.Loose)||(o.preventDefault(),(u=v(d))==null||u.focus()))}),$(H,r),J(L(()=>C(e.value,{[0]:F.Open,[1]:F.Closed}))),()=>{let{name:o,modelValue:a,disabled:u,...f}=i,g={open:e.value===0,disabled:u};return j(N,[...o!=null&&a!=null?ae({[o]:a}).map(([h,V])=>j(oe,W({features:ie.Hidden,key:h,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:h,value:V}))):[],I({props:{...n,...K(f,["onUpdate:modelValue","horizontal","multiple","by"])},slot:g,slots:x,attrs:n,name:"Listbox"})])}}}),Te=M({name:"ListboxLabel",props:{as:{type:[Object,String],default:"label"}},setup(i,{attrs:x,slots:n}){let S=P("ListboxLabel"),e=`headlessui-listbox-label-${A()}`;function p(){var d;(d=v(S.buttonRef))==null||d.focus({preventScroll:!0})}return()=>{let d={open:S.listboxState.value===0,disabled:S.disabled.value},m={id:e,ref:S.labelRef,onClick:p};return I({props:{...i,...m},slot:d,attrs:x,slots:n,name:"ListboxLabel"})}}}),ke=M({name:"ListboxButton",props:{as:{type:[Object,String],default:"button"}},setup(i,{attrs:x,slots:n,expose:S}){let e=P("ListboxButton"),p=`headlessui-listbox-button-${A()}`;S({el:e.buttonRef,$el:e.buttonRef});function d(t){switch(t.key){case c.Space:case c.Enter:case c.ArrowDown:t.preventDefault(),e.openListbox(),k(()=>{var l;(l=v(e.optionsRef))==null||l.focus({preventScroll:!0}),e.value.value||e.goToOption(b.First)});break;case c.ArrowUp:t.preventDefault(),e.openListbox(),k(()=>{var l;(l=v(e.optionsRef))==null||l.focus({preventScroll:!0}),e.value.value||e.goToOption(b.Last)});break}}function m(t){switch(t.key){case c.Space:t.preventDefault();break}}function s(t){e.disabled.value||(e.listboxState.value===0?(e.closeListbox(),k(()=>{var l;return(l=v(e.buttonRef))==null?void 0:l.focus({preventScroll:!0})})):(t.preventDefault(),e.openListbox(),re(()=>{var l;return(l=v(e.optionsRef))==null?void 0:l.focus({preventScroll:!0})})))}let O=X(L(()=>({as:i.as,type:x.type})),e.buttonRef);return()=>{var w,y;let t={open:e.listboxState.value===0,disabled:e.disabled.value},l={ref:e.buttonRef,id:p,type:O.value,"aria-haspopup":!0,"aria-controls":(w=v(e.optionsRef))==null?void 0:w.id,"aria-expanded":e.disabled.value?void 0:e.listboxState.value===0,"aria-labelledby":e.labelRef.value?[(y=v(e.labelRef))==null?void 0:y.id,p].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:d,onKeyup:m,onClick:s};return I({props:{...i,...l},slot:t,attrs:x,slots:n,name:"ListboxButton"})}}}),Ce=M({name:"ListboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0}},setup(i,{attrs:x,slots:n,expose:S}){let e=P("ListboxOptions"),p=`headlessui-listbox-options-${A()}`,d=D(null);S({el:e.optionsRef,$el:e.optionsRef});function m(t){switch(d.value&&clearTimeout(d.value),t.key){case c.Space:if(e.searchQuery.value!=="")return t.preventDefault(),t.stopPropagation(),e.search(t.key);case c.Enter:if(t.preventDefault(),t.stopPropagation(),e.activeOptionIndex.value!==null){let l=e.options.value[e.activeOptionIndex.value];e.select(l.dataRef.value)}e.mode.value===0&&(e.closeListbox(),k(()=>{var l;return(l=v(e.buttonRef))==null?void 0:l.focus({preventScroll:!0})}));break;case C(e.orientation.value,{vertical:c.ArrowDown,horizontal:c.ArrowRight}):return t.preventDefault(),t.stopPropagation(),e.goToOption(b.Next);case C(e.orientation.value,{vertical:c.ArrowUp,horizontal:c.ArrowLeft}):return t.preventDefault(),t.stopPropagation(),e.goToOption(b.Previous);case c.Home:case c.PageUp:return t.preventDefault(),t.stopPropagation(),e.goToOption(b.First);case c.End:case c.PageDown:return t.preventDefault(),t.stopPropagation(),e.goToOption(b.Last);case c.Escape:t.preventDefault(),t.stopPropagation(),e.closeListbox(),k(()=>{var l;return(l=v(e.buttonRef))==null?void 0:l.focus({preventScroll:!0})});break;case c.Tab:t.preventDefault(),t.stopPropagation();break;default:t.key.length===1&&(e.search(t.key),d.value=setTimeout(()=>e.clearSearch(),350));break}}let s=G(),O=L(()=>s!==null?s.value===F.Open:e.listboxState.value===0);return()=>{var y,T,r,o;let t={open:e.listboxState.value===0},l={"aria-activedescendant":e.activeOptionIndex.value===null||(y=e.options.value[e.activeOptionIndex.value])==null?void 0:y.id,"aria-multiselectable":e.mode.value===1?!0:void 0,"aria-labelledby":(o=(T=v(e.labelRef))==null?void 0:T.id)!=null?o:(r=v(e.buttonRef))==null?void 0:r.id,"aria-orientation":e.orientation.value,id:p,onKeydown:m,role:"listbox",tabIndex:0,ref:e.optionsRef};return I({props:{...i,...l},slot:t,attrs:x,slots:n,features:B.RenderStrategy|B.Static,visible:O.value,name:"ListboxOptions"})}}}),Me=M({name:"ListboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(i,{slots:x,attrs:n,expose:S}){let e=P("ListboxOption"),p=`headlessui-listbox-option-${A()}`,d=D(null);S({el:d,$el:d});let m=L(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===p:!1),s=L(()=>C(e.mode.value,{[0]:()=>e.compare(R(e.value.value),R(i.value)),[1]:()=>R(e.value.value).some(r=>e.compare(R(r),R(i.value)))})),O=L(()=>C(e.mode.value,{[1]:()=>{var o;let r=R(e.value.value);return((o=e.options.value.find(a=>r.some(u=>e.compare(R(u),R(a.dataRef.value)))))==null?void 0:o.id)===p},[0]:()=>s.value})),t=L(()=>({disabled:i.disabled,value:i.value,textValue:"",domRef:d}));E(()=>{var o,a;let r=(a=(o=v(d))==null?void 0:o.textContent)==null?void 0:a.toLowerCase().trim();r!==void 0&&(t.value.textValue=r)}),E(()=>e.registerOption(p,t)),z(()=>e.unregisterOption(p)),E(()=>{Q([e.listboxState,s],()=>{e.listboxState.value===0&&(!s.value||C(e.mode.value,{[1]:()=>{O.value&&e.goToOption(b.Specific,p)},[0]:()=>{e.goToOption(b.Specific,p)}}))},{immediate:!0})}),q(()=>{e.listboxState.value===0&&(!m.value||e.activationTrigger.value!==0&&k(()=>{var r,o;return(o=(r=v(d))==null?void 0:r.scrollIntoView)==null?void 0:o.call(r,{block:"nearest"})}))});function l(r){if(i.disabled)return r.preventDefault();e.select(i.value),e.mode.value===0&&(e.closeListbox(),k(()=>{var o;return(o=v(e.buttonRef))==null?void 0:o.focus({preventScroll:!0})}))}function w(){if(i.disabled)return e.goToOption(b.Nothing);e.goToOption(b.Specific,p)}function y(){i.disabled||m.value||e.goToOption(b.Specific,p,0)}function T(){i.disabled||!m.value||e.goToOption(b.Nothing)}return()=>{let{disabled:r}=i,o={active:m.value,selected:s.value,disabled:r},a={id:p,ref:d,role:"option",tabIndex:r===!0?void 0:-1,"aria-disabled":r===!0?!0:void 0,"aria-selected":s.value===!0?s.value:void 0,disabled:void 0,onClick:l,onFocus:w,onPointermove:y,onMousemove:y,onPointerleave:T,onMouseleave:T};return I({props:{...K(i,["value","disabled"]),...a},slot:o,attrs:n,slots:x,name:"ListboxOption"})}}});export{we as Listbox,ke as ListboxButton,Te as ListboxLabel,Me as ListboxOption,Ce as ListboxOptions};
