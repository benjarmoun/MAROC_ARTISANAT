import{Fragment as z,computed as R,defineComponent as V,h as $,inject as J,nextTick as M,onMounted as W,onUnmounted as G,provide as Q,ref as D,toRaw as v,watch as U,watchEffect as H}from"vue";import{Features as j,render as E,omit as N,compact as X}from"../../utils/render.js";import{useId as L}from"../../hooks/use-id.js";import{Keys as g}from"../../keyboard.js";import{calculateActiveIndex as Y,Focus as y}from"../../utils/calculate-active-index.js";import{dom as I}from"../../utils/dom.js";import{useOpenClosed as Z,State as K,useOpenClosedProvider as ee}from"../../internal/open-closed.js";import{match as k}from"../../utils/match.js";import{useResolveButtonType as te}from"../../hooks/use-resolve-button-type.js";import{useTreeWalker as oe}from"../../hooks/use-tree-walker.js";import{sortByDomNode as ne}from"../../utils/focus-management.js";import{useOutsideClick as ae}from"../../hooks/use-outside-click.js";import{Hidden as le,Features as ie}from"../../internal/hidden.js";import{objectToFormEntries as ue}from"../../utils/form.js";var re=(i=>(i[i.Open=0]="Open",i[i.Closed=1]="Closed",i))(re||{}),se=(i=>(i[i.Single=0]="Single",i[i.Multi=1]="Multi",i))(se||{}),pe=(i=>(i[i.Pointer=0]="Pointer",i[i.Other=1]="Other",i))(pe||{});let _=Symbol("ComboboxContext");function A(n){let O=J(_,null);if(O===null){let i=new Error(`<${n} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(i,A),i}return O}let Me=V({name:"Combobox",emits:{"update:modelValue":n=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},modelValue:{type:[Object,String,Number,Boolean]},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(n,{slots:O,attrs:i,emit:C}){let e=D(1),t=D(null),b=D(null),S=D(null),m=D(null),f=D({static:!1,hold:!1}),o=D([]),p=D(null),x=D(1),h=D(!1);function d(l=r=>r){let r=p.value!==null?o.value[p.value]:null,s=ne(l(o.value.slice()),c=>I(c.dataRef.domRef)),u=r?s.indexOf(r):null;return u===-1&&(u=null),{options:s,activeOptionIndex:u}}let P=R(()=>n.modelValue),w=R(()=>n.multiple?1:0),B=R(()=>n.nullable),a={comboboxState:e,value:P,mode:w,compare(l,r){return l===r},nullable:B,inputRef:b,labelRef:t,buttonRef:S,optionsRef:m,disabled:R(()=>n.disabled),options:o,change(l){C("update:modelValue",l)},activeOptionIndex:R(()=>{if(h.value&&p.value===null&&o.value.length>0){let l=o.value.findIndex(r=>!r.dataRef.disabled);if(l!==-1)return l}return p.value}),activationTrigger:x,inputPropsRef:D({displayValue:void 0}),optionsPropsRef:f,closeCombobox(){h.value=!1,!n.disabled&&e.value!==1&&(e.value=1,p.value=null)},openCombobox(){if(h.value=!0,n.disabled||e.value===0)return;let l=o.value.findIndex(r=>{let s=v(r.dataRef.value);return k(w.value,{[0]:()=>a.compare(v(a.value.value),v(s)),[1]:()=>v(a.value.value).some(c=>a.compare(v(c),v(s)))})});l!==-1&&(p.value=l),e.value=0},goToOption(l,r,s){if(h.value=!1,n.disabled||m.value&&!f.value.static&&e.value===1)return;let u=d();if(u.activeOptionIndex===null){let T=u.options.findIndex(F=>!F.dataRef.disabled);T!==-1&&(u.activeOptionIndex=T)}let c=Y(l===y.Specific?{focus:y.Specific,id:r}:{focus:l},{resolveItems:()=>u.options,resolveActiveIndex:()=>u.activeOptionIndex,resolveId:T=>T.id,resolveDisabled:T=>T.dataRef.disabled});p.value=c,x.value=s!=null?s:1,o.value=u.options},syncInputValue(){var s;let l=a.value.value;if(!I(a.inputRef))return;let r=a.inputPropsRef.value.displayValue;typeof r=="function"?a.inputRef.value.value=(s=r(l))!=null?s:"":typeof l=="string"?a.inputRef.value.value=l:a.inputRef.value.value=""},selectOption(l){let r=o.value.find(u=>u.id===l);if(!r)return;let{dataRef:s}=r;C("update:modelValue",k(w.value,{[0]:()=>s.value,[1]:()=>{let u=v(a.value.value).slice(),c=v(s.value),T=u.indexOf(c);return T===-1?u.push(c):u.splice(T,1),u}})),a.syncInputValue()},selectActiveOption(){if(a.activeOptionIndex.value===null)return;let{dataRef:l,id:r}=o.value[a.activeOptionIndex.value];C("update:modelValue",k(w.value,{[0]:()=>l.value,[1]:()=>{let s=v(a.value.value).slice(),u=v(l.value),c=s.indexOf(u);return c===-1?s.push(u):s.splice(c,1),s}})),a.syncInputValue(),a.goToOption(y.Specific,r)},registerOption(l,r){let s={id:l,dataRef:r},u=d(c=>[...c,s]);if(p.value===null){let c=r.value.value;k(w.value,{[0]:()=>a.compare(v(a.value.value),v(c)),[1]:()=>v(a.value.value).some(F=>a.compare(v(F),v(c)))})&&(u.activeOptionIndex=u.options.indexOf(s))}o.value=u.options,p.value=u.activeOptionIndex,x.value=1},unregisterOption(l){let r=d(s=>{let u=s.findIndex(c=>c.id===l);return u!==-1&&s.splice(u,1),s});o.value=r.options,p.value=r.activeOptionIndex,x.value=1}};ae([b,S,m],()=>{e.value===0&&a.closeCombobox()}),U([a.value,a.inputRef],()=>a.syncInputValue(),{immediate:!0}),U(a.comboboxState,l=>{l===1&&a.syncInputValue()},{immediate:!0}),Q(_,a),ee(R(()=>k(e.value,{[0]:K.Open,[1]:K.Closed})));let q=R(()=>a.activeOptionIndex.value===null?null:o.value[a.activeOptionIndex.value].dataRef.value);return()=>{let{name:l,modelValue:r,disabled:s,...u}=n,c={open:e.value===0,disabled:s,activeIndex:a.activeOptionIndex.value,activeOption:q.value};return $(z,[...l!=null&&r!=null?ue({[l]:r}).map(([T,F])=>$(le,X({features:ie.Hidden,key:T,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:T,value:F}))):[],E({props:{...i,...N(u,["nullable","multiple","onUpdate:modelValue","by"])},slot:c,slots:O,attrs:i,name:"Combobox"})])}}}),ke=V({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"}},setup(n,{attrs:O,slots:i}){let C=A("ComboboxLabel"),e=`headlessui-combobox-label-${L()}`;function t(){var b;(b=I(C.inputRef))==null||b.focus({preventScroll:!0})}return()=>{let b={open:C.comboboxState.value===0,disabled:C.disabled.value},S={id:e,ref:C.labelRef,onClick:t};return E({props:{...n,...S},slot:b,attrs:O,slots:i,name:"ComboboxLabel"})}}}),Ve=V({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"}},setup(n,{attrs:O,slots:i,expose:C}){let e=A("ComboboxButton"),t=`headlessui-combobox-button-${L()}`;C({el:e.buttonRef,$el:e.buttonRef});function b(f){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(f.preventDefault(),e.openCombobox()),M(()=>{var o;return(o=I(e.inputRef))==null?void 0:o.focus({preventScroll:!0})}))}function S(f){switch(f.key){case g.ArrowDown:f.preventDefault(),f.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),M(()=>{var o;return(o=e.inputRef.value)==null?void 0:o.focus({preventScroll:!0})});return;case g.ArrowUp:f.preventDefault(),f.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),M(()=>{e.value.value||e.goToOption(y.Last)})),M(()=>{var o;return(o=e.inputRef.value)==null?void 0:o.focus({preventScroll:!0})});return;case g.Escape:if(e.comboboxState.value!==0)return;f.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&f.stopPropagation(),e.closeCombobox(),M(()=>{var o;return(o=e.inputRef.value)==null?void 0:o.focus({preventScroll:!0})});return}}let m=te(R(()=>({as:n.as,type:O.type})),e.buttonRef);return()=>{var p,x;let f={open:e.comboboxState.value===0,disabled:e.disabled.value},o={ref:e.buttonRef,id:t,type:m.value,tabindex:"-1","aria-haspopup":!0,"aria-controls":(p=I(e.optionsRef))==null?void 0:p.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(x=I(e.labelRef))==null?void 0:x.id,t].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:S,onClick:b};return E({props:{...n,...o},slot:f,attrs:O,slots:i,name:"ComboboxButton"})}}}),Ee=V({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function}},emits:{change:n=>!0},setup(n,{emit:O,attrs:i,slots:C,expose:e}){let t=A("ComboboxInput"),b=`headlessui-combobox-input-${L()}`;t.inputPropsRef=R(()=>n),e({el:t.inputRef,$el:t.inputRef});function S(o){switch(o.key){case g.Backspace:case g.Delete:if(t.comboboxState.value!==0||t.mode.value!==0||!t.nullable.value)return;let p=o.currentTarget;requestAnimationFrame(()=>{if(p.value===""){t.change(null);let x=I(t.optionsRef);x&&(x.scrollTop=0),t.goToOption(y.Nothing)}});break;case g.Enter:if(t.comboboxState.value!==0)return;if(o.preventDefault(),o.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case g.ArrowDown:return o.preventDefault(),o.stopPropagation(),k(t.comboboxState.value,{[0]:()=>t.goToOption(y.Next),[1]:()=>t.openCombobox()});case g.ArrowUp:return o.preventDefault(),o.stopPropagation(),k(t.comboboxState.value,{[0]:()=>t.goToOption(y.Previous),[1]:()=>{t.openCombobox(),M(()=>{t.value.value||t.goToOption(y.Last)})}});case g.Home:case g.PageUp:return o.preventDefault(),o.stopPropagation(),t.goToOption(y.First);case g.End:case g.PageDown:return o.preventDefault(),o.stopPropagation(),t.goToOption(y.Last);case g.Escape:if(t.comboboxState.value!==0)return;o.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&o.stopPropagation(),t.closeCombobox();break;case g.Tab:if(t.comboboxState.value!==0)return;t.selectActiveOption(),t.closeCombobox();break}}function m(o){O("change",o)}function f(o){t.openCombobox(),O("change",o)}return()=>{var h,d,P,w,B,a;let o={open:t.comboboxState.value===0},p={"aria-controls":(h=t.optionsRef.value)==null?void 0:h.id,"aria-expanded":t.disabled?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(d=t.options.value[t.activeOptionIndex.value])==null?void 0:d.id,"aria-multiselectable":t.mode.value===1?!0:void 0,"aria-labelledby":(B=(P=I(t.labelRef))==null?void 0:P.id)!=null?B:(w=I(t.buttonRef))==null?void 0:w.id,id:b,onKeydown:S,onChange:m,onInput:f,role:"combobox",type:(a=i.type)!=null?a:"text",tabIndex:0,ref:t.inputRef},x=N(n,["displayValue"]);return E({props:{...x,...p},slot:o,attrs:i,slots:C,features:j.RenderStrategy|j.Static,name:"ComboboxInput"})}}}),Ae=V({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(n,{attrs:O,slots:i,expose:C}){let e=A("ComboboxOptions"),t=`headlessui-combobox-options-${L()}`;C({el:e.optionsRef,$el:e.optionsRef}),H(()=>{e.optionsPropsRef.value.static=n.static}),H(()=>{e.optionsPropsRef.value.hold=n.hold});let b=Z(),S=R(()=>b!==null?b.value===K.Open:e.comboboxState.value===0);return oe({container:R(()=>I(e.optionsRef)),enabled:R(()=>e.comboboxState.value===0),accept(m){return m.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:m.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(m){m.setAttribute("role","none")}}),()=>{var p,x,h,d;let m={open:e.comboboxState.value===0},f={"aria-activedescendant":e.activeOptionIndex.value===null||(p=e.options.value[e.activeOptionIndex.value])==null?void 0:p.id,"aria-labelledby":(d=(x=I(e.labelRef))==null?void 0:x.id)!=null?d:(h=I(e.buttonRef))==null?void 0:h.id,id:t,ref:e.optionsRef,role:"listbox"},o=N(n,["hold"]);return E({props:{...o,...f},slot:m,attrs:O,slots:i,features:j.RenderStrategy|j.Static,visible:S.value,name:"ComboboxOptions"})}}}),Fe=V({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(n,{slots:O,attrs:i,expose:C}){let e=A("ComboboxOption"),t=`headlessui-combobox-option-${L()}`,b=D(null);C({el:b,$el:b});let S=R(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),m=R(()=>k(e.mode.value,{[0]:()=>e.compare(v(e.value.value),v(n.value)),[1]:()=>v(e.value.value).some(d=>e.compare(v(d),v(n.value)))})),f=R(()=>({disabled:n.disabled,value:n.value,domRef:b}));W(()=>e.registerOption(t,f)),G(()=>e.unregisterOption(t)),H(()=>{e.comboboxState.value===0&&(!S.value||e.activationTrigger.value!==0&&M(()=>{var d,P;return(P=(d=I(b))==null?void 0:d.scrollIntoView)==null?void 0:P.call(d,{block:"nearest"})}))});function o(d){if(n.disabled)return d.preventDefault();e.selectOption(t),e.mode.value===0&&(e.closeCombobox(),M(()=>{var P;return(P=I(e.inputRef))==null?void 0:P.focus({preventScroll:!0})}))}function p(){if(n.disabled)return e.goToOption(y.Nothing);e.goToOption(y.Specific,t)}function x(){n.disabled||S.value||e.goToOption(y.Specific,t,0)}function h(){n.disabled||!S.value||e.optionsPropsRef.value.hold||e.goToOption(y.Nothing)}return()=>{let{disabled:d}=n,P={active:S.value,selected:m.value,disabled:d},w={id:t,ref:b,role:"option",tabIndex:d===!0?void 0:-1,"aria-disabled":d===!0?!0:void 0,"aria-selected":m.value===!0?m.value:void 0,disabled:void 0,onClick:o,onFocus:p,onPointermove:x,onMousemove:x,onPointerleave:h,onMouseleave:h};return E({props:{...n,...w},slot:P,attrs:i,slots:O,name:"ComboboxOption"})}}});export{Me as Combobox,Ve as ComboboxButton,Ee as ComboboxInput,ke as ComboboxLabel,Fe as ComboboxOption,Ae as ComboboxOptions};
